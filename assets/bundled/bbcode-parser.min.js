/* Source code in bbcode-src */
!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports):"function"==typeof define&&define.amd?define(["exports"],e):e((t="undefined"!=typeof globalThis?globalThis:t||self).bbcodeParser={})}(this,(function(t){"use strict";const e=t=>"object"==typeof t&&!!t.tag;function n(t,n,s,r){n.walk((n=>e(n)&&t[n.tag]?t[n.tag](n,s,r):n))}const s=(t,e,n)=>({tag:t,attrs:e,content:n}),r=t=>{const e=Object.keys(t).join(" "),n=Object.values(t).join(" ");return e===n?{_default:n}:t},o=t=>{if(!t.attrs)return`[${t.tag}]`;const e=r(t.attrs);return e._default?`[${t.tag}=${e._default}]`:t.toTagStart()},a=(t,e,n)=>{const s=t.substring(n||0).search(e);return s>=0?s+(n||0):s},i="\x3c!-- bbcode injected newlines --\x3e\n\n",c="\n\n\x3c!-- bbcode pre injected newlines --\x3e",l="\x3c!-- bbcode injected newlines --\x3e",u=new RegExp(`^${/(http|ftp|https|upload):\/\/([\w_-]+(?:(?:\.[\w_-]+)+))([\w.,@?^=%&:\/~+#-]*[\w@?^=%&\/~+#-])/.source}|${/\!?\[.*\]\((http|ftp|https|upload):\/\/([\w_-]+(?:(?:\.[\w_-]+)+))([\w.,@?^=%&:\/~+#-]*[\w@?^=%&\/~+#-])\)/.source}$`),g=/((\n|^)(?<fence>```+|~~~+)(?<fenceInfo>.*\n))|(?<bbcode>\[(?<bbcodeTag>i?code|plain)(=.*)?\])|(?<backtick>(?<tickStart>`{1,2})(.*)(?<tickEnd>\k<tickStart>))/im,d=/^(\|[^\n]+\|\r?\n)((?:\| ?:?[-]+:? ?)+\|)(\n(?:\|[^\n]+\|\r?\n?)*)?$/m;function b(){let t=(new Date).getTime();return window.performance&&"function"==typeof window.performance.now&&(t+=performance.now()),"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,(function(e){const n=(t+16*Math.random())%16|0;return t=Math.floor(t/16),("x"===e?n:3&n|8).toString(16)}))}const p={left:t=>s("div",{class:"bb-left"},t.content),center:t=>s("div",{class:"bb-center"},t.content),right:t=>s("div",{class:"bb-right"},t.content)},h={a:t=>{const e=r(t.attrs)._default||"";return s("a",{id:`user-anchor-${e.trim()}`,name:`user-anchor-${e.trim()}`},t.content)},goto:t=>{const e=r(t.attrs)._default||"";s("a",{href:`#user-anchor-${e.trim()}`},t.content)}},f=["arial","book antiqua","courier new","georgia","tahoma","times new roman","trebuchet ms","verdana"],m={thin:"100",extralight:"200",light:"300",regular:"400",medium:"500",semibold:"600",bold:"700",extrabold:"800",black:"900"},v=["ital","opsz","slnt","wdth","wght"],y=/(?<named_weight>[a-zA-Z]*)?\s?(?<weight>[0-9]*)?\s?(?<italic>italic)?/;const w=s("div",{class:"bb-email-header"},""),x=s("div",{class:"bb-email-footer"},s("div",{class:"bb-email-button"},""));const $=["me","them","right","left"],k={textmessage:t=>{const e=r(t.attrs)._default||"Recipient";return{tag:"div",attrs:{class:"bb-textmessage"},content:[{tag:"div",attrs:{class:"bb-textmessage-name"},content:e&&""!==e.trim()?e:"Recipient"},{tag:"div",attrs:{class:"bb-textmessage-overflow"},content:[{tag:"div",attrs:{class:"bb-textmessage-content"},content:t.content}]}]}},message:t=>{let e=r(t.attrs)._default.toLowerCase();$.includes(e)&&"right"!==e||(e="me"),"left"===e&&(e="them");return{tag:"div",attrs:{class:"me"===e?"bb-message-me":"bb-message-them"},content:[{tag:"div",attrs:{class:"bb-message-content"},content:t.content}]}}},T="\n",A="\t",j="=",_='"',C=" ",L="[",S="]",N="/",O="\\",E=t=>"object"==typeof t&&!!t.tag,W=t=>"string"==typeof t,I=(t,e,n)=>Object.keys(t).reduce(e,n),U=t=>E(t)?t.content.reduce(((t,e)=>t+U(e)),0):W(t)?t.length:0,V=t=>t.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;").replace(/(javascript|data|vbscript):/gi,"$1%3A"),D=(t,e)=>{const n=typeof e,s={boolean:()=>e?`${t}`:"",number:()=>`${t}="${e}"`,string:()=>`${t}="${V(e)}"`,object:()=>`${t}="${V(JSON.stringify(e))}"`};return s[n]?s[n]():""},G=t=>null==t?"":I(t,((e,n)=>[...e,D(n,t[n])]),[""]).join(" "),z=(t,e)=>{const n=I(s=e,((t,e)=>s[e]===e?s[e]:null),null);var s;if(n){const s=D(t,n),r={...e};delete r[n];return`${s}${G(r)}`}return`${t}${G(e)}`};class q{attr(t,e){return void 0!==e&&(this.attrs[t]=e),this.attrs[t]}append(t){return((t,e)=>{t.content.push(e)})(this,t)}get length(){return U(this)}toTagStart({openTag:t=L,closeTag:e=S}={}){return`${t}${z(this.tag,this.attrs)}${e}`}toTagEnd({openTag:t=L,closeTag:e=S}={}){return`${t}${N}${this.tag}${e}`}toTagNode(){return new q(this.tag.toLowerCase(),this.attrs,this.content)}toString({openTag:t=L,closeTag:e=S}={}){const n=0===this.content.length,s=this.content.reduce(((n,s)=>n+s.toString({openTag:t,closeTag:e})),""),r=this.toTagStart({openTag:t,closeTag:e});return n?r:`${r}${s}${this.toTagEnd({openTag:t,closeTag:e})}`}constructor(t,e,n){this.tag=t,this.attrs=e,this.content=Array.isArray(n)?n:[n]}}q.create=(t,e={},n=[])=>new q(t,e,n),q.isOf=(t,e)=>t.tag===e;const M=Symbol("slide-title-open"),B=Symbol("slide-title-close"),R=Symbol("slide-close"),P=/(?<slideTitleOpen>\{slide=)|(?<slideTitleClose>\})|(?<slideClose>\{\/slide\})/i;function F(t){switch(t){case M:return"{slide=";case B:return"}";case R:return"{/slide}";default:return t}}const J={accordion:t=>{const e=b(),n=function(t){t=[...t];const e=[];for(;t.length>0;){const n=t[0];if(E(n)){e.push(t.shift());continue}const s=a(n,P);if(-1===s){e.push(t.shift());continue}const r=n.match(P),o=n.slice(0,s),i=n.slice(s+r[0].length);o.length&&e.push(o),r.groups.slideTitleOpen&&e.push(M),r.groups.slideTitleClose&&e.push(B),r.groups.slideClose&&e.push(R),i.length?t[0]=i:t.shift()}return e}(t.content),i=function(t){const e=[];let n=null,s=null;for(const r of t)if(r===M&&null===s)n=q.create("slide"),n.content=[],n.customTitle=[],s=M;else{if(r===B&&s===M){s=B;continue}r===R&&n&&s===B?(e.push(n),n=null,s=null):n?s===M?n.customTitle.push(F(r)):n.content.push(F(r)):e.push(F(r))}return e}(n),c=i.filter((t=>E(t)&&"slide"===t.tag)).map((t=>(t.isValid=!0,t.groupId=e,t)));if(!c.length)return[o(t),...t.content,t.toTagEnd()];const l=r(t.attrs);if(l._default){const t=l._default.split("|").map((t=>t.trim()));t.includes("bright")&&(l.bright=!0),t.includes("bcenter")&&(l.bcenter=!0),t.includes("bleft")&&(l.bleft=!0),t.includes("fleft")&&(l.fleft=!0),t.includes("fright")&&(l.fright=!0),(t.some((t=>t.endsWith("px")))||t.some((t=>t.endsWith("%"))))&&(l.width=t.find((t=>t.endsWith("px")||t.endsWith("%"))))}let u=Object.keys(l).filter((t=>["bright","bcenter","bleft","fleft","fright"].includes(t))).join(" "),g="";return(l.width?.endsWith("px")||l.width?.endsWith("%"))&&(g=`width: ${l.width};`),s("div",{class:"bb-accordion "+u,"data-group-id":e,style:g},c)},slide:t=>{if(!t.isValid)return[o(t),...t.content,t.toTagEnd()];const e=r(t.attrs);let n=[e.title||e._default||"Slide"],s=!!e.open||!1,a=e.left?"left":e.right?"right":e.center?"center":"left";if(t.customTitle?.length){n=t.customTitle;const e=n.filter((t=>"string"==typeof t)).join("").toLowerCase().split("|").map((t=>t.trim()));e.includes("open")&&(s=!0),e.includes("right")&&(a="right"),e.includes("center")&&(a="center"),e.includes("left")&&(a="left"),n=n.map((t=>(W(t)&&(t=t.replace(/\|(open|right|center|left)/gi,"")),t)))}return[{tag:"details",attrs:{class:"bb-slide",open:s},content:[{tag:"summary",attrs:{class:"bb-slide-title",style:`text-align: ${a}; ${e.style||""}`},content:n},{tag:"div",attrs:{class:"bb-slide-content"},content:t.content}]}]}},Z=["init","click","change","input","dblclick","mouseenter","mouseleave","scroll"],H={...J,...p,...h,animation:(t,e)=>{e.data.previewing||e.data.commonGUID||(e.data.commonGUID="post-"+Math.random().toString(36).substring(2,7));const n=e.data.previewing?"preview":e.data.commonGUID,s=r(t.attrs)?._default||"",o=t.content.filter((t=>E(t)&&"keyframe"===t.tag)).map((t=>{t.isValid=!0;const e=r(t.attrs)._default||"";t.ident=e+(e.match(/^\d+$/)?"%":"");const n=t.content.filter(W).join("").replaceAll(/[\[\]\{\}]/g,"");return t.formatted=`${t.ident}{ ${n} }`,t})),a=`@keyframes ${n}${s} { ${o.map((t=>t.formatted)).join("\n")} }`;return e.data.styles.push(a),[]},bg:t=>{const e=r(t.attrs)._default;return s("div",{style:`background-color: ${e};`,class:"bb-background"},t.content)},block:t=>{const e="block",n=(r(t.attrs)._default||e).toLowerCase();return{tag:"table",attrs:{class:"bb-block","data-bb-block":["block","dice","dice10","setting","warning","storyteller","announcement","important","question","encounter","information","character","treasure"].includes(n)?n:e},content:[{tag:"tbody",content:[{tag:"tr",content:[{tag:"td",attrs:{class:"bb-block-icon"}},{tag:"td",attrs:{class:"bb-block-content"},content:t.content}]}]}]}},blockquote:t=>{const e=r(t.attrs)._default||"";return{tag:"div",attrs:{class:"bb-blockquote"},content:[{tag:"div",attrs:{class:"bb-blockquote-left"}},{tag:"div",attrs:{class:"bb-blockquote-content"},content:[t.content,{tag:"div",attrs:{class:"bb-blockquote-speaker"},content:""+(""!==e?`- ${e}`:"")}]},{tag:"div",attrs:{class:"bb-blockquote-right"}}]}},border:t=>{const e=r(t.attrs)._default;return s("div",{style:`border: ${e};`,class:"bb-border"},t.content)},br:()=>s("br",{},null),centerblock:t=>{const e=r(t.attrs)._default||"50";return s("div",{style:`margin: 0 auto; width: ${e}%`},t.content)},check:t=>{const e=r(t.attrs)._default||"dot";return s("div",{class:"bb-check","data-type":e},t.content)},class:(t,e)=>{const n=r(t.attrs),s=n.name||n._default;e.data.previewing||e.data.commonGUID||(e.data.commonGUID="post-"+Math.random().toString(36).substring(2,7));const o=e.data.previewing?"preview":e.data.commonGUID,a=s+"__"+o,i=t.content.filter(W).map((t=>t.replaceAll("{post_id}",o).replaceAll(/[\[\]\{\}]/g,"")));let c="";const l=[];return["hover","focus","active","focus-within","focus-visible"].includes(n.state?.toLowerCase())&&(c=":"+n.state.toLowerCase()),n.selector&&(c=n.selector.replace(/[,{}\\\n]/g,"")),n.minWidth?.match(/^[0-9]+[a-z]+$/)&&l.push(`(min-width: ${n.minWidth})`),n.maxWidth?.match(/^[0-9]+[a-z]+$/)&&l.push(`(max-width: ${n.maxWidth})`),i.unshift(`.${a}${c} {`),i.push("}"),l.length&&(i.unshift(`@media ${l.join(" and ")} {`),i.push("}")),e.data.styles.push(i.join("")),[]},code:t=>({isWhitespaceSensitive:!0,content:["```"+(r(t.attrs)._default||"bbcode")+"\n",t.content,"\n```\n"]}),color:t=>{const e=r(t.attrs)._default||"";return""===e.trim()?t.content:s("span",{style:`color: ${e}`},t.content)},comment:t=>s("span",{class:"hidden"},t.content),div:(t,e)=>{const n=r(t.attrs),o=n.style||n._default,a=n.class;if(!a?.trim())return s("div",{style:o},t.content);e.data.previewing||e.data.commonGUID||(e.data.commonGUID="post-"+Math.random().toString(36).substring(2,7));const i=e.data.previewing?"preview":e.data.commonGUID,c=a.split(" ").map((t=>t+"__"+i)).join(" ");return s("div",{class:c,style:o},t.content)},divide:t=>{const e=(r(t.attrs)._default||"").toLowerCase();return s("span",{class:"bb-divide","data-type":e},t.content)},fieldset:t=>({tag:"fieldset",attrs:{class:"bb-fieldset"},content:[{tag:"legend",attrs:{class:"bb-fieldset-legend"},content:r(t.attrs)._default||""},{tag:"div",attrs:{class:"bb-fieldset"},content:t.content}]}),font:(t,e)=>{const n=r(t.attrs),o=n?._default||n.family||n.name;if(""===o.trim())return t.content;if(f.includes(o.trim().toLowerCase()))return s("span",{style:"font-family: "+o},t.content);const a=(t=>{let e={ital:0,wght:400};if(t?.style){const n=t.style.trim().toLowerCase(),s=y.exec(n).groups||{};s?.italic&&(e.ital=1);const r=s.weight;r&&r>=0&&r<=900?e.wght=r:Object.keys(m).includes(s.named_weight||"")&&(e.wght=m[s.named_weight]),e={...e,...Object.fromEntries(Object.entries(t).filter((([t])=>v.includes(t))))}}return e})(n),i=((t,e)=>(t=t.replaceAll(" ","+"),e=Object.keys(e).sort().reduce(((t,n)=>(t[n]=e[n],t)),{}),"https://fonts.googleapis.com/css2?family="+t+":"+Object.keys(e).join(",")+"@"+Object.values(e).join(",")))(o,a);e.data.fonts.add(i);const c=1===a.ital?"italic":"normal",l=Object.entries(a).filter((([t])=>"wght"!==t&&"ital"!==t));let u="";return l.length&&(u="font-variation-settings: "+l.map((([t,e])=>`'${t}' ${e}`)).join(", ")+";"),s("span",{style:`font-family: ${o}; font-weight: ${a.wght}; font-style: ${c}; ${u}`,"data-font":i},t.content)},h:t=>s("h1",{},t.content),h1:t=>s("h1",{},t.content),h2:t=>s("h2",{},t.content),h3:t=>s("h3",{},t.content),h4:t=>s("h4",{},t.content),h5:t=>s("h5",{},t.content),h6:t=>s("h6",{},t.content),heightrestrict:t=>{const e=function(t){const e=t&&""!==t.trim()?t.replace(/[^\d.]/g,""):0;return e&&e>=0&&e<=700?e:0===e?0:700}(r(t.attrs)._default).toString();return s("div","0"===e?{class:"bb-height-restrict"}:{class:"bb-height-restrict",style:`height: ${e}px;`},t.content)},highlight:t=>s("span",{class:"bb-highlight"},t.content),icode:t=>({isWhitespaceSensitive:!0,content:["`",t.content,"`"]}),imagefloat:t=>{const e=r(t.attrs)._default||"";return s("div",{class:`bb-float-${e}`},t.content)},inlinespoiler:t=>s("span",{class:"bb-inline-spoiler"},t.content),justify:t=>s("div",{class:"bb-justify"},t.content),keyframe:t=>t.isValid?[]:[o(t),...t.content,t.toTagEnd()],mail:t=>{const e=r(t.attrs);let n={mailOption:(e.type||"send").toLowerCase(),person:e.person||"Unknown",subject:e.subject||"Empty"};return s("div",{class:"bb-email","data-bb-email":n.mailOption},[w,(i=n.person,s("div",{class:"bb-email-address"},i)),(a=n.subject,s("div",{class:"bb-email-subject"},a)),(o=t.content,s("div",{class:"bb-email-content"},o)),x]);var o,a,i},newspaper:t=>s("div",{class:"bb-newspaper"},t.content),nobr:t=>({disableLineBreakConversion:!0,content:t.content}),note:t=>s("div",{class:"bb-note"},[s("div",{class:"bb-note-tape"},""),s("div",{class:"bb-note-content"},[t.content,s("div",{class:"bb-note-footer"},"")])]),ooc:t=>s("div",{class:"bb-ooc"},t.content),pindent:t=>s("span",{class:"bb-pindent"},t.content),plain:t=>t.content,print:t=>{const e="print",n=(r(t.attrs)._default||e).toLowerCase(),o=["print","line","graph","parchment"].includes(n)?n:e;return s("div",{class:o===e?"bb-print":`bb-print-${o}`},t.content)},progress:t=>{const e=r(t.attrs)._default;return{tag:"div",attrs:{class:"bb-progress"},content:[{tag:"div",attrs:{class:"bb-progress-text"},content:t.content},{tag:"div",attrs:{class:"bb-progress-bar",style:`width: calc(${e}% - 6px)`}},{tag:"div",attrs:{class:"bb-progress-bar-other"}}]}},thinprogress:t=>{const e=r(t.attrs)._default;return{tag:"div",attrs:{class:"bb-progress-thin"},content:[{tag:"div",attrs:{class:"bb-progress-text"},content:t.content},{tag:"div",attrs:{class:"bb-progress-bar",style:`width: calc(${e}% - 6px)`}},{tag:"div",attrs:{class:"bb-progress-bar-other"}}]}},savenl:t=>({isWhitespaceSensitive:!0,content:t.content}),sh:t=>s("h2",{},t.content),script:(t,e)=>{const n=r(t.attrs);e.data.previewing||e.data.commonGUID||(e.data.commonGUID="post-"+Math.random().toString(36).substring(2,7));const s=e.data.previewing?"preview":e.data.commonGUID,o=Z.includes(n.on?.toLowerCase()||"init")&&n.on?.toLowerCase()||"init",a={id:s,class:n.class||"",on:o,version:n.version||"",content:t.content.join("")};return e.data.bbscripts.push(a),[]},scroll:t=>{const e=function(t){const e=t&&""!==t.trim()?t.replace(/[^\d.]/g,""):0;return e&&e>=0&&e<=700?e:0===e?0:700}(r(t.attrs)._default);return s("div",{class:"bb-scroll",style:`height: ${e}px`},t.content)},side:t=>{const e=r(t.attrs)._default||"left";return s("div",{class:"bb-side","data-side":e},t.content)},size:t=>{const e=function(t){let e,n={valid:!0};const s=/(\d+\.?\d?)(px|rem)?/i.exec(t),r=36,o=8,a=3,i=.2,c=7,l=1;if(s&&(e=s[1])){switch(n.unit=(s[2]||"").toLowerCase(),n.unit){case"px":e>r?e=r:e<o&&(e=o);break;case"rem":e>a?e=a:e<i&&(e=i);break;default:(n.valid=t.length===e.length)&&(e>c?e=c:e<l&&(e=l))}n.value=e}return n}(r(t.attrs)._default);if(!e.valid)return t.content;let n={};return n=e.unit?{style:`font-size: ${e.value}${e.unit}`}:{"data-size":e.value},s("span",n,t.content)},spoiler:t=>{const e=r(t.attrs)._default;return{tag:"details",attrs:{class:"bb-spoiler"},content:[{tag:"summary",content:"Spoiler"+(e?`: ${e}`:"")},{tag:"div",attrs:{class:"bb-spoiler-content"},content:t.content}]}},sub:t=>s("sub",{},t.content),sup:t=>s("sup",{},t.content),tab:t=>{if(!t.isValid)return[o(t),...t.content,t.toTagEnd()];const e=r(t.attrs),n=e._default||e.name||"Tab",a=`tab-${n.replace(/\W/g,"_")}-${b()}`;return[s("input",{type:"radio",id:a,name:"tab-group-"+t.groupId,class:"bb-tab",checked:t.open}),s("label",{class:"bb-tab-label",for:a,style:e.style},n),s("div",{class:"bb-tab-content"},t.content)]},tabs:t=>{const e=t.content.filter((t=>E(t)&&"tab"===t.tag)),n=b();return e.forEach((t=>{t.isValid=!0,t.groupId=n})),e.length?(e[0].open=!0,s("div",{class:"bb-tabs"},e)):[o(t),...t.content,t.toTagEnd()]},...k,b:t=>s("span",{class:"bbcode-b"},t.content),i:t=>s("span",{class:"bbcode-i"},t.content),u:t=>s("span",{class:"bbcode-u"},t.content),s:t=>s("span",{class:"bbcode-s"},t.content)},K=Object.keys(H),Q=function t(e,s=n){const r=(t={})=>{r.options=Object.assign(r.options||{},t);const n=(t,n)=>s(e,t,n,r.options);return n.options=r.options,n};return r.extend=n=>t(n(e,r.options),s),r}(H),X="type",Y="value",tt="line",et=t=>t&&void 0!==t[Y]?t[Y]:"",nt=t=>et(t).charCodeAt(0)===N.charCodeAt(0);class st{isEmpty(){return isNaN(this[X])}isText(){return!(!(t=this)||void 0===t[X]||5!==t[X]&&6!==t[X]&&1!==t[X]);var t}isTag(){return!(!(t=this)||void 0===t[X])&&2===t[X];var t}isAttrName(){return!(!(t=this)||void 0===t[X])&&3===t[X];var t}isAttrValue(){return!(!(t=this)||void 0===t[X])&&4===t[X];var t}isStart(){return!nt(this)}isEnd(){return nt(this)}getName(){return(t=>{const e=et(t);return nt(t)?e.slice(1):e})(this)}getValue(){return et(this)}getLine(){return(t=this)&&t[tt]||0;var t}getColumn(){return(t=this)&&t.row||0;var t}toString(){return(t=>{let e=L;return e+=et(t),e+=S,e})(this)}constructor(t,e,n,s){this[X]=Number(t),this[Y]=String(e),this[tt]=Number(n),this.row=Number(s)}}function rt(t,e){const n={pos:0,len:t.length},s=()=>n.len>n.pos,r=(t=1,s)=>{n.pos+=t,e&&e.onSkip&&!s&&e.onSkip()},o=()=>t[n.pos];this.skip=r,this.hasNext=s,this.getCurr=o,this.getRest=()=>t.substring(n.pos),this.getNext=()=>{const e=n.pos+1;return e<=t.length-1?t[e]:null},this.getPrev=()=>{const e=n.pos-1;return void 0!==t[e]?t[e]:null},this.isLast=()=>n.pos===n.len,this.includes=e=>t.indexOf(e,n.pos)>=0,this.grabWhile=(e,a)=>{let i=0;if(s())for(i=n.pos;s()&&e(o());)r(1,a);return t.substring(i,n.pos)},this.grabN=(e=0)=>t.substring(n.pos,n.pos+e),this.substrUntilChar=e=>{const{pos:s}=n,r=t.indexOf(e,s);return r>=0?t.substring(s,r):""}}const ot=(t,e)=>new rt(t,e);function at(t=[]){const e=t;this.push=t=>e.push(t),this.toArray=()=>e,this.getLast=()=>Array.isArray(e)&&e.length>0&&void 0!==e[e.length-1]?e[e.length-1]:null,this.flushLast=()=>!!e.length&&e.pop()}const it=(t=[])=>new at(t);function ct(t,e={}){const n=0,s=1,r=2,o=0,a=1,i=2;let c=0,l=0,u=-1,g=n,d=o,b="";const p=new Array(Math.floor(t.length)),h=e.openTag||L,f=e.closeTag||S,m=!!e.enableEscapeTags,v=e.contextFreeTags||[],y=e.onToken||(()=>{}),w=[f,h,_,O,C,A,j,T,"!"],x=[h,C,A,T],$=[C,A],k=[j,C,A],E=t=>w.indexOf(t)>=0,W=t=>t===T,I=t=>$.indexOf(t)>=0,U=t=>-1===x.indexOf(t),V=t=>k.indexOf(t)>=0,D=t=>t===h||t===f||t===O,G=t=>t===O,z=()=>{l++},q=t=>((t,e)=>{for(;t.charAt(0)===e;)t=t.substring(1);for(;t.charAt(t.length-1)===e;)t=t.substring(0,t.length-1);return t})(t,_).replace(O+_,_),M=(t,e)=>{""!==b&&e&&(b=""),""===b&&v.includes(t)&&(b=t)},B=ot(t,{onSkip:z});function R(t,e){const n=((t,e,n=0,s=0)=>new st(t,e,n,s))(t,e,c,l);y(n),u+=1,p[u]=n}function P(t,e){if(d===a){const e=t=>!(t===j||I(t)),n=t.grabWhile(e),s=t.isLast(),r=t.getCurr()!==j;return t.skip(),s||r?R(4,q(n)):R(3,n),s?o:r?a:i}if(d===i){let n=!1;const s=s=>{const r=s===_,o=t.getPrev(),a=t.getNext(),i=o===O,c=a===j,l=I(s),u=I(a);return!(!n||!V(s))||!!(!r||i||(n=!n,n||c||u))&&(!!e||!1===l)},r=t.grabWhile(s);return t.skip(),R(4,q(r)),t.isLast()?o:a}const n=t.grabWhile((e=>!(e===j||I(e)||t.isLast())));if(R(2,n),M(n),t.skip(),e)return i;return t.includes(j)?a:i}function F(){const t=B.getCurr(),e=B.getNext();B.skip();const s=B.substrUntilChar(f),o=0===s.length||s.indexOf(h)>=0;if(E(e)||o||B.isLast())return R(1,t),n;const a=-1===s.indexOf(j),i=s[0]===N;if(a||i){const t=B.grabWhile((t=>t!==f));return B.skip(),R(2,t),M(t,i),n}return r}function J(){const t=B.grabWhile((t=>t!==f),!0),e=ot(t,{onSkip:z}),s=e.includes(C);for(d=o;e.hasNext();)d=P(e,!s);return B.skip(),n}function Z(){if(W(B.getCurr()))return R(6,B.getCurr()),B.skip(),l=0,c++,n;if(I(B.getCurr())){return R(5,B.grabWhile(I)),n}if(B.getCurr()===h){if(b){const t=h.length+1+b.length,e=`${h}${N}${b}`;if(B.grabN(t)===e)return s}else if(B.includes(f))return s;return R(1,B.getCurr()),B.skip(),n}if(m){if(G(B.getCurr())){const t=B.getCurr(),e=B.getNext();return B.skip(),D(e)?(B.skip(),R(1,e),n):(R(1,t),n)}const t=t=>U(t)&&!G(t);return R(1,B.grabWhile(t)),n}return R(1,B.grabWhile(U)),n}return{tokenize:function(){for(g=n;B.hasNext();)switch(g){case s:g=F();break;case r:g=J();break;default:g=Z()}return p.length=u+1,p},isTokenNested:function(e){const n=h+N+e.getValue();return t.indexOf(n)>-1}}}const lt=(t,e={})=>{const n=e,s=n.openTag||L,r=n.closeTag||S,o=(n.onlyAllowTags||[]).filter(Boolean).map((t=>t.toLowerCase()));let a=null;const i=it(),c=it(),l=it(),u=it(),g=new Set,d=t=>Boolean(g.has(t)),b=()=>{l.flushLast()&&u.flushLast()},p=()=>{const t=c.getLast();return t&&Array.isArray(t.content)?t.content:i.toArray()},h=(t,e=!0)=>{const n=p();Array.isArray(n)&&(n.push(t.toTagStart({openTag:s,closeTag:r})),t.content.length&&(t.content.forEach((t=>{n.push(t)})),e&&n.push(t.toTagEnd({openTag:s,closeTag:r}))))},f=t=>{const e=p();var n;Array.isArray(e)&&(E(t)?(n=t.tag,!o.length||o.indexOf(n.toLowerCase())>=0?e.push(t.toTagNode()):h(t)):e.push(t))},m=t=>{b();const e=q.create(t.getValue()),n=(t=>{const e=t.getValue();return!g.has(e)&&a.isTokenNested&&a.isTokenNested(t)?(g.add(e),!0):g.has(e)})(t);l.push(e),n?c.push(e):f(e)},v=t=>{t.isStart()&&m(t),t.isEnd()&&(t=>{b();const e=c.flushLast();if(e)f(e);else if("function"==typeof n.onError){const e=t.getValue(),s=t.getLine(),r=t.getColumn();n.onError({message:`Inconsistent tag '${e}' on line ${s} and column ${r}`,tagName:e,lineNumber:s,columnNumber:r})}})(t)};a=(e.createTokenizer?e.createTokenizer:ct)(t,{onToken:t=>{t.isTag()?v(t):(t=>{const e=l.getLast(),n=t.getValue(),s=d(t);if(e)if(t.isAttrName())u.push(n),e.attr(u.getLast(),"");else if(t.isAttrValue()){const t=u.getLast();t?(e.attr(t,n),u.flushLast()):e.attr(n,n)}else t.isText()?s?e.append(n):f(n):t.isTag()&&f(t.toString());else t.isText()?f(n):t.isTag()&&f(t.toString())})(t)},openTag:s,closeTag:r,onlyAllowTags:n.onlyAllowTags,contextFreeTags:n.contextFreeTags,enableEscapeTags:n.enableEscapeTags}),a.tokenize();const y=c.flushLast();return y&&d(y.tag)&&h(y,!1),i.toArray()},ut=t=>"object"==typeof t,gt=t=>"boolean"==typeof t;function dt(t,e){const n=t;if(Array.isArray(n))for(let t=0;t<n.length;t++)n[t]=dt(e(n[t]),e);else n&&ut(n)&&n.content&&dt(n.content,e);return n}function bt(t,e){return typeof t==typeof e&&(ut(t)&&null!==t?Array.isArray(t)?t.every((t=>[].some.call(e,(e=>bt(t,e))))):Object.keys(t).every((n=>{const s=e[n],r=t[n];return ut(r)&&null!==r&&null!==s?bt(r,s):gt(r)?r!==(null===s):s===r})):t===e)}function pt(t,e){return Array.isArray(t)?dt(this,(n=>{for(let s=0;s<t.length;s++)if(bt(t[s],n))return e(n);return n})):dt(this,(n=>bt(t,n)?e(n):n))}function ht(t){return dt(this,t)}const ft="/>",mt="</",vt="<",yt=">",wt=(t,{stripTags:e=!1}={})=>[].concat(t).reduce(((t,n)=>t+((t,{stripTags:e=!1})=>{if(!t)return"";const n=typeof t;return"string"===n||"number"===n?t:"object"===n?!0===e?wt(t.content,{stripTags:e}):null===t.content?[vt,t.tag,G(t.attrs),ft].join(""):[vt,t.tag,G(t.attrs),yt,wt(t.content),mt,t.tag,yt].join(""):Array.isArray(t)?wt(t,{stripTags:e}):""})(n,{stripTags:e})),""),xt=wt,$t=t=>{const e=t;if(Array.isArray(e))for(let t=0;t<e.length;t++){const n=$t(e[t]);Array.isArray(n)?(e.splice(t,1,...n),t+=n.length-1):e[t]=n}else e&&"object"==typeof e&&e.content&&$t(e.content);if(W(e)&&e.length>1&&" "===e[0]){let t=e.length;return[String.fromCharCode(160).repeat(t)]}return e};function kt(t){return t.replaceAll(i,"").replaceAll(c,"").replaceAll("\n"+l,"").replaceAll(l+"\n","").replaceAll(l,"")}function Tt(t,e){const n=e.hoistMap;for(const[e,s]of Object.entries(n))t=t.replaceAll(e,s);return t}function At(t,e){if(0===e.styles.length)return t;return'<template data-bbcode-plus="class">'+e.styles.join("\n")+"</template>"+t}function jt(t,e){if(0===e.bbscripts.length)return t;return e.bbscripts.map((t=>`<template data-bbcode-plus="script" data-bbscript-id="${t.id}" data-bbscript-class="${t.class}" data-bbscript-on="${t.on}" data-bbscript-ver="${t.version}">${t.content}</template>`)).join("")+t}const _t=t=>"string"==typeof t,Ct=(t,e=!1)=>{const n=t;if(Array.isArray(n)){n.some(_t)&&(n.unshift(i),n.push(i));for(let t=0;t<n.length;t++){const s=Ct(n[t],e);Array.isArray(s)?(n.splice(t,1,...s),t+=s.length-1):n[t]=s}}else{if(n&&"object"==typeof n&&n.content)return n.isWhitespaceSensitive||(n.disableLineBreakConversion&&(e=!0),Ct(n.content,e)),n.tag?n:n.content;if(_t(n)&&u.test(n.trim()))return[n,c]}return _t(n)&&n===T?e?["\n",i]:[{tag:"br",content:null},i]:n};function Lt(t,e){const n={};let s=0;const r=(e,s,r,o=!1)=>{const a=b();return-1!==s?(n[a]=t.substring(e,s),t=t.substring(0,e)+a+t.substring(s)):(n[a]=t.substring(e),t=t.substring(0,e)+a+r),o&&(n[a].startsWith("\n")&&(n[a]=n[a].substring(1)),n[a].endsWith("\n")&&(n[a]=n[a].substring(0,n[a].length-1))),e+a.length+r.length};for(;-1!==(s=a(t,g,s));){const e=g.exec(t.substring(s));if(e.groups?.fence){const r=e.groups.fence,o=e.groups.fenceInfo;"\n"===t[s]&&(s+=1);const i=new RegExp("\n"+r+"(\n|$)"),c=a(t,i,s+r.length),l=b();n[l]=-1!==c?t.substring(s+r.length+o.length,c):t.substring(s+r.length+o.length);const u=`[saveNL]\n${r}${o}${l}\n${r}\n[/saveNL]`;t=t.substring(0,s)+u+(-1!==c?t.substring(c+1+r.length):""),s+=u.length}else if(e.groups?.bbcode){const n=e.groups.bbcode,o=`[/${e.groups.bbcodeTag.toLowerCase()}]`,a=t.toLowerCase().indexOf(o,s+1);s=r(s+n.length,a,o,!0)}else if(e.groups.backtick){const t=e.groups.backtick,n=e.groups.tickStart,o=e.groups.tickEnd;s=r(s+n.length,s+t.length-o.length,o)}}return e.hoistMap=n,[t,e]}function St(t,e){let n=0;for(;-1!==(n=a(t,d,n));){const e=d.exec(t.substring(n))[0],s=`[saveNL]\n${e}\n[/saveNL]`;t=t.substring(0,n)+s+t.substring(n+e.length),n+=s.length}return[t,e]}const Nt={onlyAllowTags:[...K],contextFreeTags:["plain","code","icode","class"],enableEscapeTags:!0,onError:t=>{Nt.previewing&&console.warn(t.message,t.lineNumber,t.columnNumber)}},Ot=Q();t.RpNBBCode=(t,e)=>{const n=[Ot];e.preserveWhitespace&&n.push((t=>$t(t))),n.push((t=>Ct(t)));const[s,r]=function(t){let e={};const n=[Lt,St];for(const s of n)[t,e]=s(t,e);return[t,e]}(t);return function(t){const e="function"==typeof t?[t]:t||[];let n={skipParse:!1};return{process(t,s){n=s||{};const r=n.parser||lt,o=n.render,a=n.data||null;if("function"!=typeof r)throw new Error('"parser" is not a function, please pass to "process(input, { parser })" right function');let i=n.skipParse?t||[]:r(t,n);const c=i;return i.messages=[],i.options=n,i.walk=ht,i.match=pt,e.forEach((t=>{i=t(i,{parse:r,render:o,iterate:dt,match:pt,data:a})||i})),{get html(){if("function"!=typeof o)throw new Error('"render" function not defined, please pass to "process(input, { render })"');return o(i,i.options)},tree:i,raw:c,messages:i.messages}}}}(n).process(s,{render:xt,...Nt,data:{...r,previewing:e.previewing,fonts:new Set,styles:[],bbscripts:[]}})},t.postprocess=function(t,e){let n=t;const s=[kt,At,jt,Tt];for(const t of s)n=t(n,e);return n}}));
//# sourceMappingURL=bbcode-parser.min.js.map
