/* Source code in bbcode-src/bbscript */
!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).bbscriptParser={})}(this,(function(e){"use strict";const t=Object.freeze({Function:Symbol("Function"),String:Symbol("String"),Identifier:Symbol("Identifier"),Int:Symbol("Int")}),s=e=>"object"==typeof e&&Object.getOwnPropertyNames(e).every((e=>["name","params"].includes(e))),r=(e,t)=>{if("string"==typeof e&&e.match(/^_(.*)_$/))return t.callerId&&t.data[t.callerId]&&void 0!==t.data[t.callerId][e]?t.data[t.callerId][e]:e.match(/^_(.*)_$/)?.[1]||e;if("string"==typeof e&&e.match(/\$\{\w+\}/)){const s=e.matchAll(/\$\{(\w+)\}/g);for(const r of s){const s=t.data?.[t.callerId]?.["_"+r[1]+"_"]||r[0];e=e.replace(r[0],s)}}return e};class n{static log=console.log;static warn=console.warn;static error=console.error;static info=console.info;static debug=console.debug}let o=class{options;functions;constructor(e,t={}){t={...t,processor:this},this.options=t,this.functions=e}async execAll(e,t,s,r=this.options){r={...this.options,...r,callerId:t,callerClass:s};for(const t of e){const e=await this.exec(t,r);if("object"==typeof(n=e)&&Object.getOwnPropertyNames(n).includes("msg")&&"stop"===n.msg)return}var n}exec(e,t){const s=t.processor.functions[e.name].func;if(s){const r=e.params;try{return s(t,...r)}catch(s){n.warn("BBScript Error",s,e.name,t)}}else n.info("invalid command",e.name,t)}parse(e){const t=[];for(let s of e.split("\n"))if(s=s.trim(),s&&!s.startsWith("//"))try{t.push(this.process(this.functions,s)[0])}catch(e){n.warn(e)}return t}process(e,s,r=0){const[o,...a]=s.split(/\s+/),i=o.toLowerCase(),l=a.join(" "),c={name:i,params:[]};if(!(i in e))throw new Error(`Invalid bbscript function name '${i}'`);const u=e[i];for(const{types:s,default:o}of u.params){let a;if(r>=l.length){if(!o){if(null==o)continue;n.warn(`Missing Parameter for ${i}`,s);continue}a=o}let u=!1;if('"'===l[r])[a,r]=this.getEnclosedParameter(l,r),u=!0;else if("'"===l[r])[a,r]=this.getEnclosedParameter(l,r,"'"),u=!0;else if(s.includes(t.Function)&&"("===l[r])try{const[t,s]=this.getEnclosedParameter(l,r,")");[a]=this.process(e,t),r=s}catch(e){n.warn(e)}else if(s.includes(t.Identifier)&&"$"===l[r]){let e=!1;try{e="{"===l[r+1]}catch{n.warn("$ found but no opening {")}e&&([a,r]=this.getEnclosedParameter(l,++r,"}"))}else l[r]&&(a=l.substring(r).split(/\s+/,2)[0],r+=a.length);for(s.includes(t.Int)&&"string"==typeof a&&!isNaN(parseFloat(a))?a=parseFloat(a):s.includes(t.String)&&u||s.includes(t.Identifier)&&(a=`_${a}_`),null!=a&&c.params.push(a);l[r]?.match(/\s/);)r++}return[c,r]}getEnclosedParameter(e,t,s='"',r=!0){const n=t,o=e.slice(n),a=e.length;for(t++;t<a;){const r=e.indexOf(s,t);if(!r){t=a;break}if("\\"!==e[r-1]){t=r;break}t=r+1}if(t>=a&&e[t]!==s)throw new Error('missing closing "');return[o.substring(r?1:0,t-n+(r?0:1)),++t]}};const a={params:[{types:[t.Function]},{types:[t.Function]},{types:[t.Function],default:null}],func:(e,t,s,r)=>e.processor.exec(t,e)?e.processor.exec(s,e):r?e.processor.exec(r,e):void 0},i=(e,t)=>(e=e?"."+r(e,t).trim()+"__"+t.callerId:$(t.target),$(e)),l={params:[{types:[t.Identifier]},{types:[t.Identifier],default:null}],func:(e,t,s="")=>{t=r(t,e)||"",t&&=t+"__"+e.callerId,i(s,e).addClass(t)}},c={params:[{types:[t.Identifier]},{types:[t.Identifier],default:null}],func:(e,t,s="")=>{t=r(t,e)||"",t&&=t+"__"+e.callerId,i(s,e).removeClass(t)}},u={params:[{types:[t.Int],default:1e3},{types:[t.Identifier],default:null}],func:(e,t=1e3,s)=>{i(s,e).fadeIn(t)}},d={params:[{types:[t.Int],default:1e3},{types:[t.Identifier],default:null}],func:(e,t=1e3,s)=>{i(s,e).fadeOut(t)}},p={params:[{types:[t.Int],default:1e3},{types:[t.Identifier],default:null}],func:(e,t=1e3,s)=>{i(s,e).fadeToggle(t)}},f={params:[{types:[t.Identifier],default:null}],func:(e,t)=>{i(t,e).hide()}},h={params:[{types:[t.Identifier],default:null}],func:(e,t)=>{i(t,e).show()}},m={params:[{types:[t.Identifier],default:null}],func:(e,t)=>i(t,e).text()},v={params:[{types:[t.String,t.Function,t.Identifier]},{types:[t.Identifier],default:null}],func:(e,t,n)=>{t=s(t)?e.processor.exec(t,e):r(t,e),i(n,e).text(t)}},g={params:[{types:[t.Int],default:1e3},{types:[t.Identifier],default:null}],func:(e,t=1e3,s)=>{i(s,e).slideDown(t)}},y={params:[{types:[t.Int],default:1e3},{types:[t.Identifier],default:null}],func:(e,t=1e3,s)=>{i(s,e).slideUp(t)}},I={params:[{types:[t.Int],default:1e3},{types:[t.Identifier],default:null}],func:(e,t=1e3,s)=>{i(s,e).slideToggle(t)}},w=[{types:[t.String,t.Function,t.Int,t.Identifier]},{types:[t.String,t.Function,t.Int,t.Identifier]}],V=(e,t,n)=>{let o,a;return o=s(t)?e.processor.exec(t,e):r(t,e),a=s(n)?e.processor.exec(n,e):r(n,e),[o,a]},b={params:w,func:(e,t,s)=>{const[r,n]=V(e,t,s);return r==n}},x={params:w,func:(e,t,s)=>{const[r,n]=V(e,t,s);return r>n}},_={params:w,func:(e,t,s)=>{const[r,n]=V(e,t,s);return r>=n}},A={params:w,func:(e,t,s)=>{const[r,n]=V(e,t,s);return r<n}},S={params:w,func:(e,t,s)=>{const[r,n]=V(e,t,s);return r>=n}},D={params:[{types:[t.Int]},{types:[t.Int]}],func:(e,t,s)=>Math.floor(Math.random()*(s-t+1)+t)},C={params:[{types:[t.String,t.Identifier]}],func:(e,t)=>{n.log(r(t,e))}},T={params:[{types:[t.Identifier]},{types:[t.Int,t.String,t.Function]}],func:(e,t,n)=>{n=s(n)?e.processor.exec(n,e):r(n,e);const o=e.callerId||"";o in e.data||(e.data[o]={}),e.data[o][t]=n}},F={params:[{types:[t.Int,t.String,t.Identifier,t.Function]},{types:[t.Int,t.String,t.Identifier,t.Function]}],func:(e,t,n)=>(t=s(t)?e.processor.exec(t,e):r(t,e))+(n=s(n)?e.processor.exec(n,e):r(n,e))},E={print:C,eq:b,ge:x,geq:_,le:A,leq:S,if:a,stop:{params:[],func:()=>({msg:"stop"})},set:T,dec:{params:[{types:[t.Identifier]},{types:[t.Int],default:1}],func:(e,t,s=1)=>{try{const r=e.callerId||"";r in e.data||(e.data[r]={}),e.data[r][t]-=s}catch(e){n.warn(`${t} is not a number`,e)}}},inc:{params:[{types:[t.Identifier]},{types:[t.Int],default:1}],func:(e,t,s=1)=>{try{const r=e.callerId||"";r in e.data||(e.data[r]={}),e.data[r][t]+=s}catch(e){n.warn(`${t} is not a number`,e)}}},addclass:l,removeclass:c,fadein:u,fadeout:d,fadetoggle:p,hide:f,show:h,gettext:m,settext:v,slidedown:g,slideup:y,slidetoggle:I,random:D,add:F};class N{_startIdx;_endIdx;constructor(e,t){this._startIdx=e,this._endIdx=t}get startIdx(){return this._startIdx}get endIdx(){return this._endIdx}findInText(e){let t=1,s=1;for(let r=0;r<e.length&&r!==this.startIdx;r++)"\n"===e[r]&&(t++,s=0),s++;return{line:t,column:s,text:e.substring(this.startIdx,this.endIdx)}}}class P extends N{_name;constructor(e,t,s){super(e,t),this._name=s}get name(){return this._name}resolveValue(e){return e.callerId&&e.data[e.callerId]&&void 0!==e.data[e.callerId][this.name]?e.data[e.callerId][this.name]:this.name}}class k extends N{_identifier;_params;constructor(e,t,s,r){super(e,t),this._identifier=s,this._params=r}get identifier(){return this._identifier}get params(){return this._params}resolveValue(e){const t=e.processor.functions[this.identifier.name];if(t){const s=this.params;try{return t(e,...s)}catch(t){n.warn("BBScript Error",t,this,e)}}n.info("invalid command",this,e)}}class M extends N{_string;constructor(e,t,s){super(e,t),this._string=s}get string(){return this._string}resolveValue(e){if(this.string.match(/\$\{\w+\}/)){let t=this.string;const s=t.matchAll(/\$\{(\w+)\}/g);for(const r of s){const s=e.data?.[e.callerId]?.["_"+r[1]+"_"]||r[0];t=t.replace(r[0],s)}return t}return this.string}}class j extends N{_items;constructor(e,t,s){super(e,t),this._items=s}get items(){return this._items}resolveValue(e){return this.items.map((t=>t.resolveValue(e)))}}class O extends N{_value;constructor(e,t,s){super(e,t),this._value=s}get value(){return this._value}resolveValue(){return+this.value}}class W extends Error{node;constructor(e,t){super(t),this.name="ASTError",this.node=e}format(e){if(null!==this.node){const t=this.node.findInText(e);this.message+=`: ${t.text} (line ${t.line}, column ${t.column})`}return this.message}}class B{ast=[];text="";length=0;errors=[];pos=0;parse(e){let t;this.text=e,this.length=this.text.length;try{this.buildAst()}catch(e){t=new W(null,e?.message)}t&&this.errors.push(t);const s=this.errors.map((e=>e.format(this.text)));return{ast:this.ast,formattedErrors:s}}buildAst(){let e;for(this.ast=[],this.errors=[],this.pos=0;this.pos<this.length&&(this.consumeWhitespace(),!(this.pos>=this.length));){if("("!==this.head()){this.errors.push(new W(null,"Expecting function call, found "+this.head()));break}e=this.processFunctionCall(),null!==e&&this.ast.push(e)}return this.ast}head(e=!0){if(this.pos<this.length)return this.text[this.pos];if(e)throw new Error("Unexpected end of script");return null}consumeWhitespace(){for(;this.pos<this.length&&this.isWhitespaceChar();)this.pos++}isWhitespaceChar(e=this.head()||""){return/\s/.test(e)}processFunctionCall(){const e=this.pos;this.pos++;const t=this.processIdentifier(")",/[^+\-_*/%<>=!a-zA-Z]/gm);this.consumeWhitespace();const s=[];for(;")"!==this.head();){this.consumeWhitespace();const e=this.head();switch(e){case"(":s.push(this.processFunctionCall());break;case'"':s.push(this.processString());break;case"[":s.push(this.processList());break;case")":break;default:"-"===e||/\d/.test(e||"")?s.push(this.processNumber()):s.push(this.processIdentifier())}}this.pos++;const r=this.pos;return new k(e,r,t,s)}processString(){let e="";const t=this.pos;this.pos++;let s=!1;for(;null!==this.head();){const t=this.head();if('"'===t){if(!s)break;e+=t,s=!1}else"\\"===t?(s&&(e+=t),s=!s):(e+=t,s=!1);this.pos++}const r=this.pos;return this.pos++,new M(t,r,e.replace("\n","\\n"))}processList(){const e=this.pos;this.pos++;const t=[];for(;null!==this.head();){this.consumeWhitespace();const e=this.head();if("]"===e)break;switch(e){case"(":t.push(this.processFunctionCall());break;case'"':t.push(this.processString());break;case"[":t.push(this.processList());break;default:"-"===e||/\d/.test(e||"")?t.push(this.processNumber("]")):t.push(this.processIdentifier("]"))}}this.pos++;const s=this.pos;return new j(e,s,t)}processNumber(e=")"){const t=this.pos;for("-"===this.head()&&this.pos++;!this.isWhitespaceChar()&&this.head()!==e;)this.pos++;const s=this.pos,r=this.text.substring(t,s),n=new O(t,s,r);return isNaN(+r)&&this.errors.push(new W(n,"Invalid number literal")),n}processIdentifier(e=")",t=/[^_a-zA-Z]/gm){const s=this.pos;for(;!this.isWhitespaceChar()&&this.head()!==e;)this.pos++;const r=this.pos,n=new P(s,r,this.text.substring(s,r));return t.test(n.name)&&this.errors.push(new W(n,"Invalid function identifier")),0===n.name.length&&this.errors.push(new W(n,"Missing function identifier")),n}}class L{options;functions;constructor(e,t={}){t={...t,processor:this},this.options=t,this.functions=e}execAll(e,t,s,r=this.options){r={...this.options,...r,callerId:t,callerClass:s};for(const t of e)t.resolveValue(r)}}const U=(e,t)=>{if(void 0!==t){const s="."+String(t.resolveValue(e)).trim()+"__"+e.callerId;return $(s)}return $(e.target)},q=(e,t)=>t.map((t=>{const s=t.resolveValue(e);if("number"!=typeof s)throw new W(t,"Does not resolve to a number");return s})),z={count:(e,t)=>{const s=t.resolveValue(e);if(Array.isArray(s)||"string"==typeof s)return s.length;throw new W(t,"Does not resolve to an array or string")},contain:(e,t,s)=>{const r=t.resolveValue(e),n=s.resolveValue(e);if(Array.isArray(r)&&void 0!==n)return r.includes(n);if("string"==typeof r&&void 0!==n)return r.includes(n);if(!Array.isArray(r)||"string"!=typeof r)throw new W(t,"Does not resolve to an array or string");return!1},find:(e,t,s)=>{const r=t.resolveValue(e),n=s.resolveValue(e);if(Array.isArray(r)&&void 0!==n)return r.indexOf(n);if(!Array.isArray(r))throw new W(t,"Does not resolve to an array");return-1},index:(e,t,s,r)=>{const n=t.resolveValue(e),o=+s.resolveValue(e);if(!Array.isArray(n))throw new W(t,"Does not resolve to an array");if(void 0===r)return n[o];const a=r.resolveValue(e);return n[o]=a,n[o]},append:(e,t,s)=>{const r=t.resolveValue(e),n=s.resolveValue(e);if(!Array.isArray(r))throw new W(t,"Does not resolve to an array");return r.push(n)},insert:(e,t,s,r)=>{const n=t.resolveValue(e);if(!Array.isArray(n))throw new W(t,"Does not resolve to an array");const o=+s.resolveValue(e);if("number"!=typeof o)throw new W(s,"Does not resolve to a number");const a=r.resolveValue(e);n.splice(Math.floor(o),0,a)},pop:(e,t)=>{const s=t.resolveValue(e);if(!Array.isArray(s))throw new W(t,"Does not resolve to an array");return s.pop()},remove:(e,t,s)=>{const r=t.resolveValue(e);if(!Array.isArray(r))throw new W(t,"Does not resolve to an array");const n=+s.resolveValue(e);return r.splice(n,1)[0]},reverse:(e,t)=>{const s=t.resolveValue(e);if(!Array.isArray(s))throw new W(t,"Does not resolve to an array");return s.reverse()},join:(e,t,s)=>{const r=t.resolveValue(e);let n="";if(!Array.isArray(r))throw new W(t,"Does not resolve to an array");return void 0!==s&&(n=String(s.resolveValue(e))),r.join(n)},shuffle:(e,t)=>{const s=t.resolveValue(e);if(!Array.isArray(s))throw new W(t,"Does not resolve to an array");for(let e=s.length-1;e>0;e--){const t=Math.floor(Math.random()*(e+1));[s[e],s[t]]=[s[t],s[e]]}return s},slice:(e,t,s,r)=>{const n=t.resolveValue(e);if(!Array.isArray(n)&&"string"!=typeof n)throw new W(t,"Does not resolve to an array or string");const o=+s.resolveValue(e),a=+r.resolveValue(e);return n.slice(o,a)},each:(e,t,s,r)=>{const n=t.resolveValue(e);if(!Array.isArray(n))throw new W(t,"Does not resolve to an array");const o=void 0!==r?String(r.resolveValue(e)):"_";null==e.data[e.callerId]&&(e.data[e.callerId]={});for(const t of n)e.data[e.callerId][o]=t,s.resolveValue(e);delete e.data[e.callerId][o]},addClass:(e,t,s)=>{let r=String(t.resolveValue(e));r&&=r+"__"+e.callerId;U(e,s).addClass(r)},removeClass:(e,t,s)=>{let r=String(t.resolveValue(e));r&&=r+"__"+e.callerId;U(e,s).removeClass(r)},fadeIn:(e,t,s)=>{const r=U(e,s);if(void 0!==t){const s=+t.resolveValue(e);r.fadeIn(s||1e3)}else r.fadeIn(1e3)},fadeOut:(e,t,s)=>{const r=U(e,s);if(void 0!==t){const s=+t.resolveValue(e);r.fadeOut(s||1e3)}else r.fadeOut(1e3)},fadeToggle:(e,t,s)=>{const r=U(e,s);if(void 0!==t){const s=+t.resolveValue(e);r.fadeToggle(s||1e3)}else r.fadeToggle(1e3)},hide:(e,t)=>{U(e,t).hide()},show:(e,t)=>{U(e,t).show()},getText:(e,t)=>U(e,t).text(),setText:(e,t,s)=>{const r=U(e,s),n=t.resolveValue(e);r.text(n)},slideDown:(e,t,s)=>{const r=U(e,s);if(void 0!==t){const s=+t.resolveValue(e);r.slideDown(s||1e3)}else r.slideDown(1e3)},slideUp:(e,t,s)=>{const r=U(e,s);if(void 0!==t){const s=+t.resolveValue(e);r.slideUp(s||1e3)}else r.slideUp(1e3)},slideToggle:(e,t,s)=>{const r=U(e,s);if(void 0!==t){const s=+t.resolveValue(e);r.slideToggle(s||1e3)}else r.slideToggle(1e3)},addDiv:(e,t,s)=>{const r=U(e,s);let n="";const o=t.resolveValue(e);n=Array.isArray(o)?o.map((t=>t+"__"+e.callerId)).join(" "):o+"__"+e.callerId,r.append(`<div class="${n}"></div>`)},removeDiv:(e,t,s)=>{const r=U(e,s);let n="";const o=t.resolveValue(e);n=Array.isArray(o)?"."+o.map((t=>t+"__"+e.callerId)).join("."):"."+o+"__"+e.callerId,r.remove(n)},and:(e,...t)=>t.every((t=>!!t.resolveValue(e))),or:(e,...t)=>t.some((t=>!!t.resolveValue(e))),"==":(e,t,s)=>t.resolveValue(e)==s.resolveValue(e),"!=":(e,t,s)=>t.resolveValue(e)!=s.resolveValue(e),">":(e,t,s)=>t.resolveValue(e)>s.resolveValue(e),">=":(e,t,s)=>t.resolveValue(e)>=s.resolveValue(e),"<":(e,t,s)=>t.resolveValue(e)<s.resolveValue(e),"<=":(e,t,s)=>t.resolveValue(e)<=s.resolveValue(e),if:(e,t,s,r)=>t.resolveValue(e)?s.resolveValue(e):void 0!==r?r.resolveValue(e):void 0,group:(e,...t)=>{const s=t.map((t=>t.resolveValue(e)));return s[s.length-1]},stop:()=>{throw new Error("BBScript Stop Command")},random:()=>Math.random(),randomInt:(e,t,s)=>{const r=+t.resolveValue(e),n=+s.resolveValue(e);return Math.floor(Math.random()*(n-r+1)+r)},time:()=>(new Date).getTime(),setTimeout:(e,t,s)=>{const r=t.resolveValue(e);if("number"!=typeof r)throw new W(t,"Does not resolve to a number");return setTimeout((()=>{s.resolveValue(e)}),Math.round(1e3*r))},clearTimeout:(e,t)=>{const s=+t.resolveValue(e);clearTimeout(s)},setInterval:(e,t,s)=>{const r=t.resolveValue(e);if("number"!=typeof r)throw new W(t,"Does not resolve to a number");return setInterval((()=>s.resolveValue(e)),Math.round(1e3*r))},clearInterval:(e,t)=>{const s=+t.resolveValue(e);clearInterval(s)},print:(e,...t)=>{const s=t.map((t=>t.resolveValue(e)));n.log(...s)},split:(e,t,s)=>{const r=String(t.resolveValue(e));let n="";if(void 0!==s){const t=s.resolveValue(e);"string"==typeof t&&(n=t)}return r.split(n)},lower:(e,t)=>String(t.resolveValue(e)).toLowerCase(),upper:(e,t)=>String(t.resolveValue(e)).toUpperCase(),trim:(e,t)=>String(t.resolveValue(e)).trim(),replace:(e,t,s,r)=>String(t.resolveValue(e)).replaceAll(s.resolveValue(e),r.resolveValue(e)),"=":(e,t,s)=>{const r=s.resolveValue(e);let n;if(t instanceof P)return n=t.name,null==e.data[e.callerId]&&(e.data[e.callerId]={}),void(e.data[e.callerId][n]=r);throw new W(t,"Cannot assign to non identifier")},"+":(e,...t)=>t.map((t=>t.resolveValue(e))).reduce(((e,t)=>e+t)),"-":(e,...t)=>q(e,t).reduce(((e,t)=>e-t)),"*":(e,...t)=>q(e,t).reduce(((e,t)=>e*t)),"/":(e,...t)=>q(e,t).reduce(((e,t)=>e/t)),"%":(e,t,s)=>{const[r,n]=q(e,[t,s]);return r%n},"**":(e,t,s)=>{const[r,n]=q(e,[s,t]);return n**r},"--":(e,t)=>{if(!(t instanceof P))throw new W(t,"Not an identifier variable");{const s=t.name;if(null==e.data[e.callerId]||null==e.data[e.callerId][s])throw new W(t,"Identifier not set yet");if("number"!=typeof e.data[e.callerId][s])throw new W(t,"Not a number");e.data[e.callerId][s]-=1}},"++":(e,t)=>{if(!(t instanceof P))throw new W(t,"Not an identifier variable");{const s=t.name;if(null==e.data[e.callerId]||null==e.data[e.callerId][s])throw new W(t,"Identifier not set yet");if("number"!=typeof e.data[e.callerId][s])throw new W(t,"Not a number");e.data[e.callerId][s]+=1}}};const Z={},J=function(e){return new o(E,{data:e})}(Z),{processor:G,parser:H}=function(e){return{processor:new L(z,{data:e}),parser:new B}}(Z);console.info("BBCodePlus Addon JS Loaded"),e.bbscript2Parser=H,e.bbscriptData=Z,e.bbscriptProcessorV1=J,e.bbscriptProcessorV2=G}));
//# sourceMappingURL=bbscript-parser.min.js.map
